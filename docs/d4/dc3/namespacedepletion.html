<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.10"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>ORIGEN API: depletion Module Reference</title>
        <!--<link href="../../tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="../../dynsections.js"></script>
        <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
        <link href="../../doxygen.css" rel="stylesheet" type="text/css" />
        <link href="../../customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../../doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">ORIGEN API v0.5.2</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Overview</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../modules.html"><span>Components</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../d1/d5b/md__c_h_a_n_g_e_l_o_g.html"><span>Changelog</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../namespacemembers.html"><span>Namespace&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">depletion Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>The predictor-corrector mechanism and solver encapsulation.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a4942f37401b222891148bcc3db4b003a"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/dc3/namespacedepletion.html#a4942f37401b222891148bcc3db4b003a">deplete</a> (solver_opts, lib, itot, n0, n, delta_t, source_term, flux, power, input_by_flux, is_adjoint, fixed_fission_energy, reprocessing_rate, feed_rate, adjoint_source_term_reaction, adjoint_source_term_decay)</td></tr>
<tr class="memdesc:a4942f37401b222891148bcc3db4b003a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Perform a single depletion step (including the predictor/corrector mechanism).  <a href="#a4942f37401b222891148bcc3db4b003a">More...</a><br /></td></tr>
<tr class="separator:a4942f37401b222891148bcc3db4b003a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a32394a1939eeed9617d854c8e8d7ee62"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/dc3/namespacedepletion.html#a32394a1939eeed9617d854c8e8d7ee62">depletion_step</a> (solver_opts, lib, itot, n0, n, delta_t, corrector, powrst, fluxst, source_term, flux, power, input_by_flux, is_adjoint, fixed_fission_energy, reprocessing_rate, feed_rate, adjoint_source_term_reaction, adjoint_source_term_decay)</td></tr>
<tr class="memdesc:a32394a1939eeed9617d854c8e8d7ee62"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run the solver once.  <a href="#a32394a1939eeed9617d854c8e8d7ee62">More...</a><br /></td></tr>
<tr class="separator:a32394a1939eeed9617d854c8e8d7ee62"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f9bd77787c870643eaa6bc94422e10e"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/dc3/namespacedepletion.html#a6f9bd77787c870643eaa6bc94422e10e">powerflux</a> (lib, itot, power, flux, concentrations, input_by_flux, fixed_fission_energy, is_adjoint)</td></tr>
<tr class="memdesc:a6f9bd77787c870643eaa6bc94422e10e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Convert power to flux or vice versa.  <a href="#a6f9bd77787c870643eaa6bc94422e10e">More...</a><br /></td></tr>
<tr class="separator:a6f9bd77787c870643eaa6bc94422e10e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af5e4df00aa7e166474d1b885717e2b97"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/dc3/namespacedepletion.html#af5e4df00aa7e166474d1b885717e2b97">fluxo</a> (corrector, powrst, fluxst, flux, power, zero_flux_step, input_by_flux)</td></tr>
<tr class="memdesc:af5e4df00aa7e166474d1b885717e2b97"><td class="mdescLeft">&#160;</td><td class="mdescRight">Computes the average flux over a time interval using predictor corrector method, build the diagonal of the transition matrix (DIAG array), convert flux to power or vice versa, multiply A matrix off-diagoal elements by flux.  <a href="#af5e4df00aa7e166474d1b885717e2b97">More...</a><br /></td></tr>
<tr class="separator:af5e4df00aa7e166474d1b885717e2b97"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8546ed5837ed07f56b9ecd00c82ea3b8"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/dc3/namespacedepletion.html#a8546ed5837ed07f56b9ecd00c82ea3b8">powerf</a> (lib, itot, factor, fission_rate, concentrations, zero_flux_step)</td></tr>
<tr class="memdesc:a8546ed5837ed07f56b9ecd00c82ea3b8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculate the power-flux conversion factor, based on given fission rate and given concentrations.  <a href="#a8546ed5837ed07f56b9ecd00c82ea3b8">More...</a><br /></td></tr>
<tr class="separator:a8546ed5837ed07f56b9ecd00c82ea3b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>The predictor-corrector mechanism and solver encapsulation. </p>
<p>This module encapsulates the predictor-corrector mechanism of depletion and provides the parts of the depletion mechanism which are common to all solvers.</p>
<p>The <code>deplete</code> subroutine executes two solver runs for predictor and corrector steps.</p>
<p>The <code>depletion_step</code> subroutine calculates the flux (or power) integrated over the time step, builds the transition matrix A for the solver (by folding the reaction and decay data together using the evaluated flux), builds up the source vector B (consisting of the user-specified constant feed term and from the terms arising from the adjoint solution, if applicable) and runs the solver itself. </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a class="anchor" id="a4942f37401b222891148bcc3db4b003a"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine depletion::deplete </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d8/d59/structsolvers_1_1solver__options.html">solver_options</a>), intent(in)&#160;</td>
          <td class="paramname"><em>solver_opts</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(origen_librarywrapper), intent(in)&#160;</td>
          <td class="paramname"><em>lib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>n0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(out)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(in)&#160;</td>
          <td class="paramname"><em>delta_t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(inout)&#160;</td>
          <td class="paramname"><em>source_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>power</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>input_by_flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>is_adjoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>fixed_fission_energy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>reprocessing_rate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>feed_rate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>adjoint_source_term_reaction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>adjoint_source_term_decay</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Perform a single depletion step (including the predictor/corrector mechanism). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">solver_opts</td><td>solver settings</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">lib</td><td>Library data</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">itot</td><td>Number of nuclides in the library</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n0</td><td>initial concentrations</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">n</td><td>final concentrations</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">source_term</td><td>Continuous processing feed rate / source term from the adjoint calculation</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">delta_t</td><td>Time step length in seconds</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">input_by_flux</td><td>flux is used for input? or power?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">is_adjoint</td><td>is this an adjoint calculation?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fixed_fission_energy</td><td>is the fission energy fixed or problem dependent?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">reprocessing_rate</td><td>continuous reprocessing rates</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">feed_rate</td><td>continuous feed rates</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adjoint_source_term_reaction</td><td>reaction component of the adjoint source term</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adjoint_source_term_decay</td><td>decay component of the adjoint source term </td></tr>
  </table>
  </dd>
</dl>
<p>buffers for predictor-corrector power and flux </p>

<p>References <a class="el" href="../../d4/dc3/namespacedepletion.html#a32394a1939eeed9617d854c8e8d7ee62">depletion_step()</a>, and <a class="el" href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">origen_iofunctions_m::rstop()</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d0f/namespaceorigen__casewrapper__m.html#a4bec2796cfd2e68b314ab931e7f1b305">origen_casewrapper_m::flip_time()</a>.</p>
<div class="fragment"><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">!   D u m m y   A r g u m e n t s</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">    !&gt; solver settings</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keywordtype">type</span>(solver_options), <span class="keywordtype">intent(in)</span> :: solver_opts<span class="comment"></span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">    !&gt; Library data</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordtype">type</span>(<a class="code" href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper</a>), <span class="keywordtype">intent(in)</span> :: lib<span class="comment"></span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">    !&gt; Number of nuclides in the library</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: itot<span class="comment"></span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">    !&gt; initial concentrations</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: n0(itot) <span class="comment">! [itot]</span><span class="comment"></span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">    !&gt; final concentrations</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(out)</span> :: n(itot) <span class="comment">! [itot]</span><span class="comment"></span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">    !&gt; Continuous processing feed rate / source term from the adjoint calculation</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: source_term(itot) <span class="comment">! [itot]</span><span class="comment"></span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">    !&gt; Time step length in seconds</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: delta_t<span class="comment"></span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">    !&gt; flux</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: flux<span class="comment"></span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">    !&gt; power</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: power<span class="comment"></span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">    !&gt; flux is used for input? or power?</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: input_by_flux<span class="comment"></span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">    !&gt; is this an adjoint calculation?</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: is_adjoint<span class="comment"></span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">    !&gt; is the fission energy fixed or problem dependent?</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: fixed_fission_energy<span class="comment"></span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">    !&gt; continuous reprocessing rates</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: reprocessing_rate(itot) <span class="comment">! [itot]</span><span class="comment"></span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">    !&gt; continuous feed rates</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: feed_rate(itot) <span class="comment">! [itot]</span><span class="comment"></span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">    !&gt; reaction component of the adjoint source term</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: adjoint_source_term_reaction(itot) <span class="comment">! [itot]</span><span class="comment"></span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">    !&gt; decay component of the adjoint source term</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: adjoint_source_term_decay(itot) <span class="comment">! [itot]</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="comment">!   L o c a l   V a r i a b l e s</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">    !&gt; buffers for predictor-corrector power and flux</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: powrst, fluxst</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    powrst = 0.d0</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    fluxst = 0.d0</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">if</span> (delta_t &lt; 0.0) <span class="keyword">call </span><a class="code" href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">rstop</a>(<span class="stringliteral">&quot;Time step length for depletion is negative.&quot;</span> ,505)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Depletion :: initial concentration sum is &quot;</span>, sum(n0))</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Depletion :: feed rate sum is &quot;</span>, sum(reprocessing_rate))</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">! run the solution (predictor step)</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keyword">call </span>depletion_step(solver_opts, lib, lib%get_itot(), n0, n, delta_t, .false., powrst, fluxst, source_term, flux, power, input_by_flux, is_adjoint, fixed_fission_energy, reprocessing_rate, feed_rate, adjoint_source_term_reaction, adjoint_source_term_decay)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Depletion :: intermediate concentration sum is &quot;</span>, sum(n))</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Depletion :: predicted flux is &quot;</span>, fluxst)</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <span class="comment">! run the solution (corrector step)</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="keyword">call </span>depletion_step(solver_opts, lib, lib%get_itot(), n0, n, delta_t, .true. , powrst, fluxst, source_term, flux, power, input_by_flux, is_adjoint, fixed_fission_energy, reprocessing_rate, feed_rate, adjoint_source_term_reaction, adjoint_source_term_decay)</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Depletion :: actual flux is &quot;</span>, flux)</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Depletion :: final concentration sum is &quot;</span>, sum(n))</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    jdebugline(<span class="stringliteral">&quot;Depletion is finished&quot;</span>)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="ttc" id="structorigen__librarywrapper__m_1_1origen__librarywrapper_html"><div class="ttname"><a href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper_m::origen_librarywrapper</a></div><div class="ttdef"><b>Definition:</b> LibraryWrapper_M.f90:26</div></div>
<div class="ttc" id="namespaceorigen__iofunctions__m_html_aa1aef71afe3a97030061d2f6ad7628fd"><div class="ttname"><a href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">origen_iofunctions_m::rstop</a></div><div class="ttdeci">subroutine rstop(message, code)</div><div class="ttdef"><b>Definition:</b> IOFunctions_M.f90:34</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a32394a1939eeed9617d854c8e8d7ee62"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine depletion::depletion_step </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d8/d59/structsolvers_1_1solver__options.html">solver_options</a>), intent(in)&#160;</td>
          <td class="paramname"><em>solver_opts</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(origen_librarywrapper), intent(in)&#160;</td>
          <td class="paramname"><em>lib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>n0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(inout)&#160;</td>
          <td class="paramname"><em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(in)&#160;</td>
          <td class="paramname"><em>delta_t</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>corrector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>powrst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(inout)&#160;</td>
          <td class="paramname"><em>source_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>power</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>input_by_flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>is_adjoint</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>fixed_fission_energy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>reprocessing_rate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>feed_rate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>adjoint_source_term_reaction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>adjoint_source_term_decay</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run the solver once. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">solver_opts</td><td>solver type identifier</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">lib</td><td>Library data</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">itot</td><td>Total number of nuclides</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n0</td><td>initial concentrations</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">n</td><td>final concentrations</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">delta_t</td><td>Time step length in seconds</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">corrector</td><td>is this a corrector step?</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">powrst</td><td>saved power for predictor-corrector</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxst</td><td>saved flux for predictor-corrector</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">source_term</td><td>Continuous processing feed rate / source term from the adjoint calculation</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">input_by_flux</td><td>flux is used for input? or power?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">is_adjoint</td><td>is this an adjoint calculation?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fixed_fission_energy</td><td>is the fission energy fixed or problem dependent?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">reprocessing_rate</td><td>continuous reprocessing rates</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">feed_rate</td><td>continuous feed rates</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adjoint_source_term_reaction</td><td>reaction component of the adjoint source term</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">adjoint_source_term_decay</td><td>decay component of the adjoint source term </td></tr>
  </table>
  </dd>
</dl>
<p>Diagonal elements of the transition matrix</p>
<p>Nondiagonal elements of the transition matrix</p>
<p>is this a zero-flux (=decay) step? </p>

<p>References <a class="el" href="../../d4/dc3/namespacedepletion.html#af5e4df00aa7e166474d1b885717e2b97">fluxo()</a>, <a class="el" href="../../dd/d83/namespacekernel__matrex.html#a7ba4ad2803715d7c6962c56b3cb86e85">kernel_matrex::matrex_solve()</a>, <a class="el" href="../../d4/dc3/namespacedepletion.html#a6f9bd77787c870643eaa6bc94422e10e">powerflux()</a>, <a class="el" href="../../df/da9/namespacekernel__radau5.html#ac6dffa00f06a74fb9e46cfc43f594a45">kernel_radau5::radau5_solve()</a>, and <a class="el" href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">origen_iofunctions_m::rstop()</a>.</p>

<p>Referenced by <a class="el" href="../../d4/dc3/namespacedepletion.html#a4942f37401b222891148bcc3db4b003a">deplete()</a>.</p>
<div class="fragment"><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="comment">!   M o d u l e s</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordtype">use </span><a class="code" href="../../dd/d83/namespacekernel__matrex.html">kernel_matrex</a></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordtype">use </span><a class="code" href="../../df/d36/namespacekernel__rksuite.html">kernel_rksuite</a></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keywordtype">use </span><a class="code" href="../../df/da9/namespacekernel__radau5.html">kernel_radau5</a></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">!   D u m m y   A r g u m e n t s</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">    !&gt; solver type identifier</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordtype">type</span>(solver_options), <span class="keywordtype">intent(in)</span> :: solver_opts<span class="comment"></span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">    !&gt; Library data</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordtype">type</span>(<a class="code" href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper</a>), <span class="keywordtype">intent(in)</span> :: lib<span class="comment"></span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">    !&gt; Total number of nuclides</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: itot<span class="comment"></span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">    !&gt; initial concentrations</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: n0(itot)<span class="comment"></span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">    !&gt; final concentrations</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: n(itot)<span class="comment"></span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">    !&gt; Time step length in seconds</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: delta_t<span class="comment"></span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">    !&gt; is this a corrector step?</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: corrector<span class="comment"></span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">    !&gt; saved power for predictor-corrector</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: powrst<span class="comment"></span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">    !&gt; saved flux for predictor-corrector</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: fluxst<span class="comment"></span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">    !&gt; Continuous processing feed rate / source term from the adjoint calculation</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: source_term(itot)<span class="comment"></span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">    !&gt; flux</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: flux<span class="comment"></span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">    !&gt; power</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: power<span class="comment"></span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">    !&gt; flux is used for input? or power?</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: input_by_flux<span class="comment"></span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">    !&gt; is this an adjoint calculation?</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: is_adjoint<span class="comment"></span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">    !&gt; is the fission energy fixed or problem dependent?</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: fixed_fission_energy<span class="comment"></span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">    !&gt; continuous reprocessing rates</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: reprocessing_rate(itot)<span class="comment"></span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">    !&gt; continuous feed rates</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: feed_rate(itot)<span class="comment"></span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">    !&gt; reaction component of the adjoint source term</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: adjoint_source_term_reaction(itot)<span class="comment"></span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">    !&gt; decay component of the adjoint source term</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: adjoint_source_term_decay(itot)</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="comment">!   L o c a l   V a r i a b l e s</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">    !&gt; Diagonal elements of the transition matrix</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">allocatable</span> :: diag(:) <span class="comment">! allocated/set by fold_flux</span><span class="comment"></span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">    !&gt; Nondiagonal elements of the transition matrix</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">allocatable</span> :: a(:) <span class="comment">! allocated/set by fold_flux</span><span class="comment"></span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">    !&gt; is this a zero-flux (=decay) step?</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordtype">logical</span> :: zero_flux_step</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="comment">! Temporary storage for compositions in MATREX substep loop</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: n0_tmp(itot)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="comment">! Substep length in MATREX substep loop</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: t_ss</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="keywordtype">integer</span> :: i</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: non0(:) <span class="comment">! extra variables for the CRAM solver (AIs)</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: kd(:)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: loc(:)</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: zai(:)</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordtype">integer</span> :: i_zero_flux_step, i_is_adjoint, source_order</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keywordtype">integer</span> :: status</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <span class="comment">! is this a zero-flux (decay-only) step?</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">if</span> (.not. input_by_flux) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;      zero_flux_step = (power &lt; err)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      zero_flux_step = (flux &lt; err)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">if</span> (zero_flux_step) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;      flux = 0.0</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      power = 0.0</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      <span class="comment">! evaluate the flux/power</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="comment">! choose the right &#39;starting&#39; concentrations</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <span class="keywordflow">if</span> (corrector) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keyword">call </span>powerflux (lib, lib%get_itot(), power, flux, n, input_by_flux, fixed_fission_energy, is_adjoint)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        jdebugline2(<span class="stringliteral">&quot;Corrector flux is &quot;</span>, flux)</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        <span class="keyword">call </span>powerflux (lib, lib%get_itot(), power, flux, n0, input_by_flux, fixed_fission_energy, is_adjoint)</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        jdebugline2(<span class="stringliteral">&quot;Predictor flux is &quot;</span>, flux)</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keywordflow">      end if</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <span class="comment">! integrate flux over time step</span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keyword">call </span>fluxo (corrector, powrst, fluxst, flux, power, zero_flux_step, input_by_flux)</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="comment">! get the A and diag</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keyword">call </span>lib%fold_flux (flux, diag, a)</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">! adjust diagonal by reprocessing</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    diag(:) = diag(:) - reprocessing_rate(:)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">! prepare source term (for adjoint calculations -- compensation for stable nuclides)</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordflow">if</span> (is_adjoint .and. (solver_opts%solver .ne. 2)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      source_term = adjoint_source_term_decay + flux * 1e-24 * adjoint_source_term_reaction</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      jdebugline2(<span class="stringliteral">&quot;Adjoint :: extra source term sum is &quot;</span>, sum(source_term(:)))</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      source_term = feed_rate</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="comment">! solve the equation dN/dt = AN+B for t = t0 + delta_t</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <span class="keywordflow">if</span> (solver_opts%solver == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;      <span class="comment">! MATREX solver (Now with a substep loop)</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">! Can use rule of 3s to make different time steps.</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">! This seems to fall apart when time steps are very small (either numerical instabilities or other problems)</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">! resulting in concentrations of zero.  Commenting out for now, but leaving in in case it is revisited in the future.</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">!~       if (zero_flux_step) then</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">!~         ! Decay step. Each substep is 3x longer than the previous</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">!~         t_ss = -2*delta_t / (1-3**solver_opts%internal_steps)</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">!~         call matrex_solve(lib%b_trx, lib%get_itot(), lib%get_non(), n0, n, t_ss, diag, a, source_term, zero_flux_step, is_adjoint, solver_opts%nterm, solver_opts%nshrt, 0.0d0)</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">!~         do i=2,solver_opts%internal_steps</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">!~           n0_tmp = n    ! copy n to n0_tmp</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">!~           t_ss = t_ss*3 ! increment step length by a factor of three</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">!~           call matrex_solve(lib%b_trx, lib%get_itot(), lib%get_non(), n0_tmp, n, t_ss, diag, a, source_term, zero_flux_step, is_adjoint, solver_opts%nterm, solver_opts%nshrt, 0.0d0)</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">!~         end do</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">!~       else</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        <span class="comment">! Depletion step. Equidistant substeps</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        t_ss = delta_t / solver_opts%internal_steps</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keyword">call </span><a class="code" href="../../dd/d83/namespacekernel__matrex.html#a7ba4ad2803715d7c6962c56b3cb86e85">matrex_solve</a>(lib%b_trx, lib%get_itot(), lib%get_non(), n0, n, t_ss, diag, a, source_term, zero_flux_step, is_adjoint, solver_opts%nterm, solver_opts%nshrt, 0.0d0)</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        <span class="keywordflow">do</span> i=2,solver_opts%internal_steps</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;          n0_tmp = n    <span class="comment">! copy n to n0_tmp</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;          <span class="keyword">call </span><a class="code" href="../../dd/d83/namespacekernel__matrex.html#a7ba4ad2803715d7c6962c56b3cb86e85">matrex_solve</a>(lib%b_trx, lib%get_itot(), lib%get_non(), n0_tmp, n, t_ss, diag, a, source_term, zero_flux_step, is_adjoint, solver_opts%nterm, solver_opts%nshrt, 0.0d0)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="keywordflow">        end do</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">!~       end if</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (solver_opts%solver == 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      <span class="keyword">call </span><a class="code" href="../../df/da9/namespacekernel__radau5.html#ac6dffa00f06a74fb9e46cfc43f594a45">radau5_solve</a>(lib%b_trx, lib%get_itot(), lib%get_non(), n0, n, delta_t, diag, a, source_term, zero_flux_step, is_adjoint, solver_opts%abstol, solver_opts%reltol)</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">!    else if (solver_opts%solver == 2) then</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">!       call volterra_solve(lib, lib%get_itot(), lib%get_non(), n0, n, delta_t, diag, a, source_term, zero_flux_step, is_adjoint, solver_opts)</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">!    else if (solver_opts%solver == 3) then</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">!      call rksuite_solve(lib%b_trx, lib%get_itot(), lib%get_non(), n0, n, delta_t, diag, a, source_term, zero_flux_step, is_adjoint)</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">!   else if (solver_opts%solver == 4) then</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">!     call expokit_solver(lib, lib%get_itot, n0, nx, t, flux)</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (solver_opts%solver == 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;      <span class="comment">! The new CRAM solver (i5q)</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#ifdef ORIGEN_DISABLE_CRAM</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor"></span>      serrline(1,*)<span class="stringliteral">&quot;ORIGEN&#39;s CRAM solver is disabled in this build so you cannot use it.&quot;</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;      stop 868</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor"></span>      <span class="keyword">call </span>lib%get_non0_(non0)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      <span class="keyword">call </span>lib%get_kd_(kd)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      <span class="keyword">call </span>lib%get_loc(loc)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      <span class="keyword">call </span>lib%get_nucl(zai)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;      <span class="comment">! CRAM solver expects C indexing but lib%get_loc adds + 1 for Fortran</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      loc = loc - 1;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      <span class="comment">! Convert logicals to integers for sending to c++</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      <span class="keywordflow">if</span> (zero_flux_step) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        i_zero_flux_step = 1</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        i_zero_flux_step = 0</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      <span class="keywordflow">if</span> (is_adjoint) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        i_is_adjoint = 1</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        i_is_adjoint = 0</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;      <span class="comment">! NOTE: this assumes that the source is (at most) constant</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      <span class="keywordflow">if</span> (any(source_term /= 0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        source_order = 0;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        source_order = -1;</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      status = <a class="code" href="../../da/def/kernel__cram_8hpp.html#aa519e485bd96a0c81aa4d4fd56b96926">kernel_cram_from_fortran</a>(n, n0, source_term, source_order, delta_t, lib%get_itot(), lib%get_non(), non0, kd, diag, a, loc, i_zero_flux_step, i_is_adjoint, solver_opts%cram_order, solver_opts%internal_steps, 2, 0.0d0, zai)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      <span class="keywordflow">if</span> (status.ne.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        <span class="keyword">call </span><a class="code" href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">rstop</a>(<span class="stringliteral">&quot;CRAM solution failed&quot;</span>,666)</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordflow">      endif</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="keyword">deallocate</span>(non0)</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      <span class="keyword">deallocate</span>(kd)</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      <span class="keyword">deallocate</span>(loc)</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="keyword">deallocate</span>(diag)</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="keyword">deallocate</span>(a)</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="ttc" id="namespacekernel__matrex_html"><div class="ttname"><a href="../../dd/d83/namespacekernel__matrex.html">kernel_matrex</a></div><div class="ttdoc">Main solver routines. </div><div class="ttdef"><b>Definition:</b> kernel_matrex.f90:9</div></div>
<div class="ttc" id="namespacekernel__radau5_html"><div class="ttname"><a href="../../df/da9/namespacekernel__radau5.html">kernel_radau5</a></div><div class="ttdoc">Wrapper for the 3rd party RADAU5 solver. </div><div class="ttdef"><b>Definition:</b> kernel_radau5.f90:10</div></div>
<div class="ttc" id="structorigen__librarywrapper__m_1_1origen__librarywrapper_html"><div class="ttname"><a href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper_m::origen_librarywrapper</a></div><div class="ttdef"><b>Definition:</b> LibraryWrapper_M.f90:26</div></div>
<div class="ttc" id="kernel__cram_8hpp_html_aa519e485bd96a0c81aa4d4fd56b96926"><div class="ttname"><a href="../../da/def/kernel__cram_8hpp.html#aa519e485bd96a0c81aa4d4fd56b96926">kernel_cram_from_fortran</a></div><div class="ttdeci">int kernel_cram_from_fortran(double *n, double *n0, double *source_term, int source_order, double delta_t, int itot, int non, int *non0, int *kd, double *diag, double *a, int *loc, int zero_flux_step, int is_adjoint, int cram_order, int internal_steps, int remove_negatives, double cutoff, int *ZAI)</div><div class="ttdef"><b>Definition:</b> kernel_cram_from_fortran.cpp:23</div></div>
<div class="ttc" id="namespacekernel__rksuite_html"><div class="ttname"><a href="../../df/d36/namespacekernel__rksuite.html">kernel_rksuite</a></div><div class="ttdoc">Wrapper for the 3rd party RKSuite90 solver. </div><div class="ttdef"><b>Definition:</b> kernel_rksuite.f90:6</div></div>
<div class="ttc" id="namespacekernel__radau5_html_ac6dffa00f06a74fb9e46cfc43f594a45"><div class="ttname"><a href="../../df/da9/namespacekernel__radau5.html#ac6dffa00f06a74fb9e46cfc43f594a45">kernel_radau5::radau5_solve</a></div><div class="ttdeci">subroutine radau5_solve(trx, itot, non, n0, n, delta_t, diag, a, b, zero_flux_step, is_adjoint, abstol, reltol)</div><div class="ttdef"><b>Definition:</b> kernel_radau5.f90:68</div></div>
<div class="ttc" id="namespacekernel__matrex_html_a7ba4ad2803715d7c6962c56b3cb86e85"><div class="ttname"><a href="../../dd/d83/namespacekernel__matrex.html#a7ba4ad2803715d7c6962c56b3cb86e85">kernel_matrex::matrex_solve</a></div><div class="ttdeci">subroutine, public matrex_solve(trx, itot, non, n0, n, delta_t, diag, a, b,                                                                                                   zero_flux_step, is_adjoint, nterm, nshrt, cutoff)</div><div class="ttdef"><b>Definition:</b> kernel_matrex.f90:130</div></div>
<div class="ttc" id="namespaceorigen__iofunctions__m_html_aa1aef71afe3a97030061d2f6ad7628fd"><div class="ttname"><a href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">origen_iofunctions_m::rstop</a></div><div class="ttdeci">subroutine rstop(message, code)</div><div class="ttdef"><b>Definition:</b> IOFunctions_M.f90:34</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a6f9bd77787c870643eaa6bc94422e10e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine depletion::powerflux </td>
          <td>(</td>
          <td class="paramtype">type(origen_librarywrapper), intent(in)&#160;</td>
          <td class="paramname"><em>lib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>power</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>concentrations</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>input_by_flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>fixed_fission_energy</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>is_adjoint</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Convert power to flux or vice versa. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">lib</td><td>Library data</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">itot</td><td>Total number of nuclides</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">flux</td><td>user-given flux (if index is 0; otherwise not used)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">power</td><td>user-given power (if index is 1; otherwise not used)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">concentrations</td><td>Concentrations to be used</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">input_by_flux</td><td>depletion by flux or by power?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fixed_fission_energy</td><td>is the fission energy fixed or problem-dependent?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">is_adjoint</td><td>is this an adjoint calculation? </td></tr>
  </table>
  </dd>
</dl>
<p>Local holder for fiss array </p>

<p>References <a class="el" href="../../d4/dc3/namespacedepletion.html#a8546ed5837ed07f56b9ecd00c82ea3b8">powerf()</a>, and <a class="el" href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">origen_iofunctions_m::rstop()</a>.</p>

<p>Referenced by <a class="el" href="../../d4/dc3/namespacedepletion.html#a32394a1939eeed9617d854c8e8d7ee62">depletion_step()</a>.</p>
<div class="fragment"><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="comment">!   D u m m y   A r g u m e n t s</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">    !&gt; Library data</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordtype">type</span>(<a class="code" href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper</a>), <span class="keywordtype">intent(in)</span> :: lib<span class="comment"></span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">    !&gt; Total number of nuclides</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: itot<span class="comment"></span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">    !&gt; user-given flux (if index is 0; otherwise not used)</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: flux<span class="comment"></span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;<span class="comment">    !&gt; user-given power (if index is 1; otherwise not used)</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: power<span class="comment"></span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">    !&gt; Concentrations to be used</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: concentrations(itot)<span class="comment"></span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">    !&gt; depletion by flux or by power?</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: input_by_flux<span class="comment"></span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">    !&gt; is the fission energy fixed or problem-dependent?</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: fixed_fission_energy<span class="comment"></span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">    !&gt; is this an adjoint calculation?</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: is_adjoint</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="comment">!   L o c a l   V a r i a b l e s</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="comment">! estimated fission rate</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: fission_rate</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="comment">! FLUX/POWER conversion factor</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: factor<span class="comment"></span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">    !&gt; Local holder for fiss array</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">allocatable</span> :: fiss(:)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    <span class="keywordtype">integer</span> :: ilite, iact</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    ilite = lib%get_ilite()</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    iact = lib%get_iact()</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keyword">call </span>lib%get_fiss(fiss)</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    <span class="comment">! calculate fission rate</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">if</span> (iact &gt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      fission_rate = 1.0d0 <span class="comment">!hack</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;       <span class="keywordflow">if</span> (.not. is_adjoint) fission_rate = dot_product(concentrations(1+ilite:iact+ilite),fiss(:iact))</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      jdebugline(<span class="stringliteral">&quot;IACT is zero, so is the fission rate&quot;</span>)</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;      fission_rate = 0.0d0</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">! get the flux-power conversion factor</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="keywordflow">if</span> (fixed_fission_energy) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      <span class="comment">! fixed 200 MeV per fission</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;      <span class="keywordflow">if</span> (fission_rate &lt; err) <span class="keyword">call </span><a class="code" href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">rstop</a> (<span class="stringliteral">&#39;Fixed fission energy release (JOPT(12)=1) requires nonzero fission rate.&#39;</span>, 11)</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;      factor = (200.0*fission_rate)/1.0364e+19</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      <span class="comment">! explicit fission energy release</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;      <span class="keywordflow">if</span> (.not. is_adjoint) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="keyword">call </span>powerf (lib, lib%get_itot(), factor, fission_rate, concentrations, .false.)</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="comment">! HACK for adjoint</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        factor = 1.0</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="keywordflow">      end if</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="comment">! convert flux and power</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordflow">if</span> (.not. input_by_flux) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;      flux = power / factor</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;      power = flux * factor</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      <span class="comment">! HACK for adjoint :: nonsense, of course</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;      <span class="keywordflow">if</span> (is_adjoint) power = 1.0</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="keyword">deallocate</span>(fiss)</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div>
<div class="ttc" id="structorigen__librarywrapper__m_1_1origen__librarywrapper_html"><div class="ttname"><a href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper_m::origen_librarywrapper</a></div><div class="ttdef"><b>Definition:</b> LibraryWrapper_M.f90:26</div></div>
<div class="ttc" id="namespaceorigen__iofunctions__m_html_aa1aef71afe3a97030061d2f6ad7628fd"><div class="ttname"><a href="../../df/d9a/namespaceorigen__iofunctions__m.html#aa1aef71afe3a97030061d2f6ad7628fd">origen_iofunctions_m::rstop</a></div><div class="ttdeci">subroutine rstop(message, code)</div><div class="ttdef"><b>Definition:</b> IOFunctions_M.f90:34</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="af5e4df00aa7e166474d1b885717e2b97"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine depletion::fluxo </td>
          <td>(</td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>corrector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>powrst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>fluxst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>flux</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(inout)&#160;</td>
          <td class="paramname"><em>power</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>zero_flux_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>input_by_flux</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Computes the average flux over a time interval using predictor corrector method, build the diagonal of the transition matrix (DIAG array), convert flux to power or vice versa, multiply A matrix off-diagoal elements by flux. </p>
<p><br />
<br />
 Given an input value for the specific power, XFLUXO solves for the average flux over the time interval by using Eq. (F7.2.30) and energy per fission data. Given an input value for the neutron flux, XFLUXO solves for the specific power by Eq. (F7.2.32). Having obtained a value for the neutron flux, XFLUXO generates the first-order rate constants for neutron-induced reactions. Then the diagonal matrix element is formed for each nuclide by combining the disintegration constant, the rate constant for neutron-induced reactions, and the rate constant for removal processes that are proportional to the nuclide concentration. The diagonal matrix elements are stored in the D array.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">corrector</td><td>false =&gt; save flux (fluxst/powrst), true =&gt; average saved and actual flux</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">powrst</td><td>saved power from predictor to corrector</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">fluxst</td><td>saved flux from predictor to corrector</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">flux</td><td>user-given flux (if index is 0; otherwise not used)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">power</td><td>user-given power (if index is 1; otherwise not used)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">zero_flux_step</td><td>is this a zero-flux step?</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">input_by_flux</td><td>depletion by flux or by power? </td></tr>
  </table>
  </dd>
</dl>

<p>Referenced by <a class="el" href="../../d4/dc3/namespacedepletion.html#a32394a1939eeed9617d854c8e8d7ee62">depletion_step()</a>.</p>
<div class="fragment"><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="comment">!   M o d u l e s</span></div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordtype">use </span><a class="code" href="../../d0/db4/namespaceconst.html">const</a></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">!   D u m m y   A r g u m e n t s</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">    !&gt; false =&gt; save flux (fluxst/powrst), true =&gt; average saved and actual flux</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: corrector<span class="comment"></span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">    !&gt; saved power from predictor to corrector</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: powrst<span class="comment"></span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">    !&gt; saved flux from predictor to corrector</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: fluxst<span class="comment"></span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">    !&gt; user-given flux (if index is 0; otherwise not used)</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: flux<span class="comment"></span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">    !&gt; user-given power (if index is 1; otherwise not used)</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(inout)</span> :: power<span class="comment"></span></div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">    !&gt; is this a zero-flux step?</span></div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: zero_flux_step<span class="comment"></span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="comment">    !&gt; depletion by flux or by power?</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: input_by_flux</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">!   L o c a l   V a r i a b l e s</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="comment">! relative saved/actual flux difference</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: delf</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="keywordflow">if</span> (.not. zero_flux_step) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;      <span class="keywordflow">if</span> (corrector) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        <span class="keywordflow">if</span> (.not. input_by_flux) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;          delf   = abs(1.0 - flux/fluxst)</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          <span class="keywordflow">if</span> (delf &gt; 0.2d0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;             scalereportwarning(1,*)<span class="stringliteral">&#39;The flux over a step has changed by more than 20%.&#39;</span> ; scalefinalizewarning()</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="keywordflow">          end if</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;          flux = (flux + fluxst)/2.0</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;          power = (power + powrst)/2.0</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="keywordflow">        end if</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        fluxst = flux</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        powrst = power</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;<span class="keywordflow">      end if</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div>
<div class="ttc" id="namespaceconst_html"><div class="ttname"><a href="../../d0/db4/namespaceconst.html">const</a></div><div class="ttdoc">Set of data, physics and string constants. </div><div class="ttdef"><b>Definition:</b> const.f90:7</div></div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="a8546ed5837ed07f56b9ecd00c82ea3b8"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine depletion::powerf </td>
          <td>(</td>
          <td class="paramtype">type(origen_librarywrapper), intent(in)&#160;</td>
          <td class="paramname"><em>lib</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>itot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(out)&#160;</td>
          <td class="paramname"><em>factor</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), intent(in)&#160;</td>
          <td class="paramname"><em>fission_rate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(c_double), dimension(itot), intent(in)&#160;</td>
          <td class="paramname"><em>concentrations</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in)&#160;</td>
          <td class="paramname"><em>zero_flux_step</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculate the power-flux conversion factor, based on given fission rate and given concentrations. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">lib</td><td>Library data</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">itot</td><td>Total number of nuclides</td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">factor</td><td>power-flux factor to be calculated</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fission_rate</td><td>normalization factor</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">concentrations</td><td>used concentrations (usually XTEMP)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">zero_flux_step</td><td>is this a zero-flux step? </td></tr>
  </table>
  </dd>
</dl>
<p>Cycle variables</p>
<p>Temporary local copies of library data objects</p>
<p>Energy library size</p>
<p>Nuclide IDs in energy library</p>
<p>Fission energy in energy library</p>
<p>Prompt gamma capture energy (mev) fission energy in energy library</p>
<p>Populate local array copies</p>
<p>Garbage collection </p>

<p>Referenced by <a class="el" href="../../d4/dc3/namespacedepletion.html#a6f9bd77787c870643eaa6bc94422e10e">powerflux()</a>.</p>
<div class="fragment"><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="comment">!   M o d u l e s</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="keywordtype">use </span>iso_c_binding<span class="keywordtype">, only</span>: c_double</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="comment">!   D u m m y   A r g u m e n t s</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="comment">    !&gt; Library data</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordtype">type</span>(<a class="code" href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper</a>), <span class="keywordtype">intent(in)</span> :: lib<span class="comment"></span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="comment">    !&gt; Total number of nuclides</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: itot<span class="comment"></span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment">    !&gt; power-flux factor to be calculated</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(out)</span> :: factor<span class="comment"></span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="comment">    !&gt; normalization factor</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: fission_rate<span class="comment"></span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">    !&gt; used concentrations (usually XTEMP)</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">intent(in)</span> :: concentrations(itot)<span class="comment"></span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">    !&gt; is this a zero-flux step?</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: zero_flux_step</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="comment">!-----------------------------------------------</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="comment">!   L o c a l   V a r i a b l e s</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">!-----------------------------------------------</span><span class="comment"></span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">    !&gt; Cycle variables</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keywordtype">integer</span> :: i, k<span class="comment"></span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment">    !&gt;</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: total_capture_energy<span class="comment"></span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment">    !&gt;</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: capture_energy<span class="comment"></span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="comment">    !&gt;</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: total_absorption<span class="comment"></span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="comment">    !&gt;</span></div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: total_fission_energy<span class="comment"></span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">    !&gt;</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> :: fission_energy</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">    !&gt; Temporary local copies of library data objects</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: nucl(:)</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: typ_nuc(:)</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">allocatable</span> :: fiss(:)</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span>, <span class="keywordtype">allocatable</span> :: tocap(:)</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">    !&gt; Energy library size</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordtype">integer</span> , <span class="keywordtype">parameter</span> :: nl = 56</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">    !&gt; Nuclide IDs in energy library</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordtype">integer</span> , <span class="keywordtype">dimension(nl)</span> :: iza = (/&amp;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;                10010,  50100,  80160, 260560, 280580, 400900, 400910, &amp;</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;       400920, 400960, 420950, 430950, 441010, 451030, 451050, 471090, &amp;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;       541310, 541350, 551330, 551340, 601430, 601450, 611470, 611480, &amp;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;       611481, 621470, 621490, 621500, 621510, 621520, 631530, 631540, &amp;</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;       631550, 902300, 902320, 902330, 912310, 912330, 922320, 922330, &amp;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;       922340, 922350, 922360, 922380, 932370, 932390, 942380, 942390, &amp;</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;       942400, 942410, 942420, 942430, 952410, 952421, 952430, 962440, &amp;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;       962450 /)</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">    !&gt; Fission energy in energy library</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> , <span class="keywordtype">dimension(nl)</span> :: fission_energy_table =  (/  &amp;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;                 0.0d0,    0.0d0,    0.0d0,     0.0d0,    0.0d0,    0.0d0,    0.0d0,    &amp;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;       0.0d0,    0.0d0,    0.0d0,    0.0d0,     0.0d0,    0.0d0,    0.0d0,    0.0d0,    &amp;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;       0.0d0,    0.0d0,    0.0d0,    0.0d0,     0.0d0,    0.0d0,    0.0d0,    0.0d0,    &amp;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;       0.0d0,    0.0d0,    0.0d0,    0.0d0,     0.0d0,    0.0d0,    0.0d0,    0.0d0,    &amp;</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;       0.0d0,    190.0d0,  189.21d0, 190.0d0,   190.0d0,  189.1d0,  200.0d0,  191.29d0, &amp;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;       190.30d0, 194.02d0, 192.80d0, 198.122d0, 195.10d0, 200.0d0,  197.80d0, 200.05d0, &amp;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;       199.79d0, 202.22d0, 200.62d0, 200.0d0,   202.3d0,  202.29d0, 202.1d0,  200.0d0, &amp;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;       200.0d0 /)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">    !&gt; Prompt gamma capture energy (mev) fission energy in energy library</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    <span class="keywordtype">real(C_DOUBLE)</span> , <span class="keywordtype">dimension(nl)</span> :: capture_energy_table = (/ &amp;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                  2.2246d0, 2.79d0,   4.143d0,  7.60d0,   9.02d0,   7.2026d0, 8.6351d0, &amp;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;       6.758d0,   5.571d0,  9.1542d0, 7.71d0,   9.2161d0, 6.9993d0, 7.0941d0, 6.825d0,  &amp;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;       8.9363d0,  7.880d0,  6.7044d0, 6.550d0,  7.8174d0, 7.5654d0, 5.90d0,   7.266d0,  &amp;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;       7.266d0,   8.1402d0, 7.9824d0, 5.596d0,  8.258d0,  5.867d0,  6.444d0,  8.167d0,  &amp;</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;       6.490d0,   5.01d0,   4.786d0,  6.08d0,   5.66d0,   5.197d0,  5.93d0,   6.841d0,  &amp;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;       5.297d0,   6.5451d0, 5.124d0,  4.804d0,  5.49d0,   4.97d0,   5.55d0,   6.533d0,  &amp;</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;       5.241d0,   6.301d0,  5.071d0,  6.02d0,   5.529d0,  6.426d0,  5.363d0,  6.451d0,  &amp;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;       6.11d0 /)</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    factor = 1.0d0</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    <span class="keywordflow">if</span> (zero_flux_step) <span class="keywordflow">return</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    jdebugline2(<span class="stringliteral">&quot;Fission rate = &quot;</span>, fission_rate)</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="comment">    !&gt; Populate local array copies</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="keyword">call </span>lib%get_nucl(nucl)</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keyword">call </span>lib%get_typ_nuc(typ_nuc)</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    <span class="keyword">call </span>lib%get_fiss(fiss)</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keyword">call </span>lib%get_tocap(tocap)</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    total_capture_energy = 0.d0</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    total_fission_energy = 0.d0</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">do</span> i = 1, lib%get_itot()</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      capture_energy = 5.0d0  <span class="comment">! default prompt gamma capture energy (mev)</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      fission_energy = 200.d0 <span class="comment">! default fission energy</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      <span class="comment">! find capture_energy and fission_energy</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      find_fission: <span class="keywordflow">do</span> k = 1, nl</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <span class="keywordflow">if</span> (nucl(i) == iza(k)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;          capture_energy = capture_energy_table(k)</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;          fission_energy = fission_energy_table(k)</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;          <span class="keywordflow">exit</span> find_fission</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="keywordflow">        end if</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordflow">      end do</span> find_fission</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      <span class="keywordflow">if</span> (concentrations(i) &gt; err) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="comment">! calculate absorption XS</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        total_absorption = tocap(i)</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <span class="keywordflow">if</span> (typ_nuc(i) == 2) total_absorption = tocap(i) - fiss(i-lib%get_ilite())</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="comment">! add to total energy release due to capture</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        total_capture_energy = total_capture_energy + total_absorption * concentrations(i) * capture_energy</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;        <span class="comment">! add to total energy release due to fission</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;        <span class="keywordflow">if</span> (typ_nuc(i) == 2 ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;          total_fission_energy = total_fission_energy + fiss(i-lib%get_ilite()) * concentrations(i) * fission_energy</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="keywordflow">        end if</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;<span class="keywordflow">      end if</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;<span class="keywordflow">    end do</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="comment">! calculate the power-flux factor</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    factor = (total_capture_energy + total_fission_energy) * 9.6483d-20  <span class="comment">!MW.s</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="comment">    !&gt; Garbage collection</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="keyword">deallocate</span>(nucl)</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keyword">deallocate</span>(typ_nuc)</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="keyword">deallocate</span>(fiss)</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="keyword">deallocate</span>(tocap)</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div>
<div class="ttc" id="structorigen__librarywrapper__m_1_1origen__librarywrapper_html"><div class="ttname"><a href="../../dc/d7b/structorigen__librarywrapper__m_1_1origen__librarywrapper.html">origen_librarywrapper_m::origen_librarywrapper</a></div><div class="ttdef"><b>Definition:</b> LibraryWrapper_M.f90:26</div></div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
